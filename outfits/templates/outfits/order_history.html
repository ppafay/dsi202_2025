{% extends 'outfits/base.html' %}
{% load static %}

{% block title %}‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ - MindVibe{% endblock %}

{% block extra_head %}
<style>
    .order-card { background-color: #fff; border: 1px solid #e0e0e0; border-radius: 8px; margin-bottom: 25px; padding: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .order-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom:10px; border-bottom: 1px solid #eee;}
    .order-header h5 { color: var(--pastel-pink-dark); margin-bottom: 0; }
    .order-meta p { margin-bottom: 5px; font-size: 0.9em; }
    .order-meta strong { color: var(--text-dark); }
    .item-list { margin-top: 15px; }
    .item-detail { display: flex; align-items: center; padding: 10px 0; border-bottom: 1px dashed #f0f0f0; }
    .item-detail:last-child { border-bottom: none; }
    .item-detail img { width: 60px; height: 80px; object-fit: cover; border-radius: 4px; margin-right: 15px; }
    .item-info p { margin-bottom: 2px; font-size: 0.85em;}
    .item-info h6 { font-size: 1em; margin-bottom: 4px;}
    .status-badge { padding: 6px 12px; border-radius: 20px; font-size: 0.85em; color: #fff; display: inline-block; font-weight:500; min-width: 140px; text-align: center;} /* Adjusted min-width */
    .status-pending_payment { background-color: #6c757d; }
    .status-payment_confirmed { background-color: #17a2b8; }
    .status-processing { background-color: #ffc107; color: #212529 !important; }
    .status-shipped { background-color: #007bff; }
    .status-delivered { background-color: #28a745; }
    .status-customer_returning { background-color: #fd7e14; }
    .status-returned_received { background-color: #6f42c1; }
    .status-completed { background-color: #20c997; }
    .status-issue_reported { background-color: #dc3545; }
    .status-cancelled { background-color: #343a40; }
    .upload-section, .return-shipment-section { margin-top: 15px; padding-top:15px; border-top: 1px solid #eee;}
    .return-shipment-section { background-color: #f8f9fa; padding: 15px; border-radius: 5px; border-top: 1px solid #007bff30;}
    .return-shipment-section h6 { color: #0056b3; }
    .upload-section .form-control, .return-shipment-section .form-control-sm {font-size: 0.9em; margin-top: 5px; margin-bottom: 10px;}
    .errorlist { color: red; font-size: 0.8em; list-style-type: none; padding-left: 0;}
</style>
{% endblock %}

{% block content %}
<div class="container" style="padding-top: 40px;">
    <h2 class="page-title" style="margin-bottom: 30px;">üßæ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h2>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{% if message.tags %}{{ message.tags }}{% else %}info{% endif %} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}

    {% for data in orders_with_forms %}
    {% with order=data.order upload_form=data.upload_form return_form=data.return_form show_return_form=data.show_return_form items_details=data.items_details latest_return_date=data.latest_return_date %}
        <div class="order-card">
            <div class="order-header">
                <h5>‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ #{{ order.id }}</h5>
                <span class="status-badge status-{{ order.rental_status|default:'pending_payment' }}">
                    {{ order.get_rental_status_display|default:"‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô" }}
                </span>
            </div>
            <div class="order-meta row">
                <div class="col-md-6">
                    <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô):</strong> {{ order.paid_at|date:"d M Y, H:i"|default:"-" }}</p>
                    <p><strong>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°:</strong> ‡∏ø{{ order.total_price|floatformat:2 }}</p>
                    {% if latest_return_date %}
                         <p><strong>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏∑‡∏ô (‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£):</strong> <span class="text-danger fw-bold">{{ latest_return_date|date:"d M Y" }}</span></p>
                    {% endif %}
                </div>
                <div class="col-md-6">
                    {% if order.payment_slip %}
                        <p><strong>‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô:</strong> <a href="{{ order.payment_slip.url }}" target="_blank">‡∏î‡∏π‡∏™‡∏•‡∏¥‡∏õ</a></p>
                    {% else %}
                        <p><em>(‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ)</em></p>
                    {% endif %}
                </div>
            </div>

            <div class="item-list">
                <h6>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πà‡∏≤:</h6>
                {% for item in items_details %}
                <div class="item-detail">
                    {% if item.image_url %}
                        <img src="{{ item.image_url }}" alt="{{ item.name }}">
                    {% else %}
                        <img src="{% static 'outfits/images/placeholder-outfit.png' %}" alt="No image">
                    {% endif %}
                    <div class="item-info">
                        <h6>{{ item.name }} (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: {{ item.quantity }})</h6>
                        {% if item.start_date and item.end_date %}
                        <p>‡πÄ‡∏ä‡πà‡∏≤: {{ item.start_date|date:"d M Y" }} - {{ item.end_date|date:"d M Y" }} ({{ item.days }} ‡∏ß‡∏±‡∏ô)</p>
                        <p>‡∏£‡∏≤‡∏Ñ‡∏≤: ‡∏ø{{ item.price|floatformat:2 }}</p>
                        {% else %}
                        <p class="text-muted"><em>(‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡πÄ‡∏ä‡πà‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ)</em></p>
                        {% endif %}
                    </div>
                </div>
                {% empty %}
                 <p><em>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ô‡∏µ‡πâ</em></p>
                {% endfor %}
            </div>

            {% if order.is_paid %}
                <div class="upload-section">
                    <h6>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤ / ‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ):</h6>
                    {% if order.customer_uploaded_image %}
                        <p>‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏ö‡πÅ‡∏•‡πâ‡∏ß: <a href="{{ order.customer_uploaded_image.url }}" target="_blank">‡∏î‡∏π‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</a></p>
                    {% else %}
                        <p class="text-muted small"><em>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ô‡∏µ‡πâ</em></p>
                    {% endif %}
                    {% if order.rental_status != 'completed' and order.rental_status != 'cancelled' %}
                    <form method="post" enctype="multipart/form-data" action="{% url 'outfits:order_history' %}">
                        {% csrf_token %}
                        <input type="hidden" name="order_id" value="{{ order.id }}">
                        <div class="mb-2">
                            {{ upload_form.customer_uploaded_image.label_tag }}
                            {{ upload_form.customer_uploaded_image }}
                            {{ upload_form.customer_uploaded_image.errors }}
                        </div>
                        <button type="submit" name="upload_customer_image" class="btn btn-sm btn-outline-secondary">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤</button>
                    </form>
                    {% endif %}
                </div>

                {% if show_return_form and order.rental_status not in "customer_returning,returned_received,completed,cancelled" %}
                <div class="return-shipment-section">
                    <h6>‡πÅ‡∏à‡πâ‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ #{{ order.id }} (‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏∑‡∏ô: {{ latest_return_date|date:"d M Y" }})</h6>
                    <form method="post" enctype="multipart/form-data" action="{% url 'outfits:order_history' %}">
                        {% csrf_token %}
                        <input type="hidden" name="order_id" value="{{ order.id }}">
                        <div class="mb-2">
                            {{ return_form.return_tracking_number.label_tag }}
                            {{ return_form.return_tracking_number }}
                            {{ return_form.return_tracking_number.errors }}
                        </div>
                        <div class="mb-2">
                            {{ return_form.return_shipment_image.label_tag }}
                            {{ return_form.return_shipment_image }}
                            {{ return_form.return_shipment_image.errors }}
                        </div>
                        <button type="submit" name="submit_return_shipment" class="btn btn-sm btn-primary">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô</button>
                    </form>
                </div>
                {% elif order.return_tracking_number %} {# Show if already submitted return info #}
                 <div class="return-shipment-section">
                    <h6>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:</h6>
                    <p class="small mb-1">‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏: <strong>{{ order.return_tracking_number }}</strong></p>
                     {% if order.return_shipment_image %}
                        <p class="small">‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á: <a href="{{ order.return_shipment_image.url }}" target="_blank">‡∏î‡∏π‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</a></p>
                     {% endif %}
                 </div>
                {% endif %}
            {% endif %}
        </div>
    {% endwith %}
    {% empty %}
        <div class="empty-state text-center py-5">
            <p style="font-size: 1.2em; color: #888;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</p>
            <a href="{% url 'outfits:outfit-list' %}" class="btn btn-primary">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∏‡∏î‡πÄ‡∏•‡∏¢</a>
        </div>
    {% endfor %}
</div>
{% endblock %}