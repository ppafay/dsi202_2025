{% extends "outfits/base.html" %}
{% load static %}
{% comment %} {% load crispy_forms_tags %} ‡∏´‡∏≤‡∏Å‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ä‡πâ crispy forms {% endcomment %}

{% block title %}‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ - MindVibe üå∏{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" href="{% static 'outfits/cart.css' %}">
    <style>
        .date-selection-form label { font-size: 0.85em; margin-bottom: 0.2rem; display: block; }
        .date-selection-form .form-control-sm { margin-bottom: 0.5rem; }
        .item-rental-info p { margin-bottom: 0.3rem; font-size: 0.9em;}
        .update-dates-btn { margin-top: 0.5rem;}
        .errorlist { color: red; font-size: 0.8em; list-style-type: none; padding-left: 0;}
    </style>
{% endblock %}

{% block content %}
<section class="cart-section">
    <div class="container">
        <h2 class="page-title">üõí ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h2>

        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{% if message.tags %}{{ message.tags }}{% else %}info{% endif %} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}

        {% if not cart or not forms_with_items %}
            <div class="empty-cart-message">
                <p>‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞</p>
                <a href="{% url 'outfits:outfit-list' %}" class="btn btn-primary">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏°‡∏ä‡∏∏‡∏î‡∏™‡∏ß‡∏¢‡πÜ ‡∏ï‡πà‡∏≠‡πÄ‡∏•‡∏¢!</a>
            </div>
        {% else %}
            <div class="cart-layout">
                <main class="cart-items-column">
                    <div class="cart-items-card">
                        {% for form_item_pair in forms_with_items %}
                        {% with item=form_item_pair.item date_form=form_item_pair.date_form %}
                        <div class="cart-item">
                            <div class="item-image">
                                <a href="{% url 'outfits:outfit-detail' item.outfit.id %}">
                                {% if item.outfit.image %}
                                    <img src="{{ item.outfit.image.url }}" alt="{{ item.outfit.name }}">
                                {% else %}
                                    <img src="{% static 'outfits/images/placeholder-outfit.png' %}" alt="No image available">
                                {% endif %}
                                </a>
                            </div>
                            <div class="item-details">
                                <h3><a href="{% url 'outfits:outfit-detail' item.outfit.id %}">{{ item.outfit.name }}</a></h3>
                                <p class="item-price-each">‡∏ø{{ item.outfit.price|floatformat:2 }} / ‡∏ß‡∏±‡∏ô</p>
                                <p class="item-price-each">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: {{ item.quantity }}</p>

                                {% if item.start_date and item.end_date %}
                                    <div class="item-rental-info">
                                        <p><strong>‡πÄ‡∏ä‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> {{ item.start_date|date:"d M Y" }}</p>
                                        <p><strong>‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> {{ item.end_date|date:"d M Y" }}</p>
                                        <p><strong>‡∏£‡∏ß‡∏°:</strong> {{ item.get_rental_days }} ‡∏ß‡∏±‡∏ô</p>
                                        <p><strong>‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ:</strong> ‡∏ø{{ item.get_total_item_price|floatformat:2 }}</p>
                                        {% if not cart.is_paid %}
                                        <small><a href="#" onclick="document.getElementById('date_form_{{ item.id }}').style.display='block'; this.style.display='none'; return false;">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ß‡∏±‡∏ô‡πÄ‡∏ä‡πà‡∏≤</a></small>
                                        {% endif %}
                                    </div>
                                {% endif %}

                                {% if date_form and not cart.is_paid %}
                                <form method="post" action="{% url 'outfits:update_cart_item_dates' item.id %}" class="date-selection-form" id="date_form_{{ item.id }}" style="{% if item.start_date and item.end_date %}display:none;{% endif %} margin-top:10px;">
                                    {% csrf_token %}
                                    <div>{{ date_form.start_date.label_tag }} {{ date_form.start_date }} {{ date_form.start_date.errors }}</div>
                                    <div>{{ date_form.end_date.label_tag }} {{ date_form.end_date }} {{ date_form.end_date.errors }}</div>
                                    <button type="submit" class="btn btn-sm btn-success update-dates-btn">
                                        {% if item.start_date and item.end_date %}‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ß‡∏±‡∏ô{% else %}‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏ä‡πà‡∏≤{% endif %}
                                    </button>
                                </form>
                                {% elif not item.start_date or not item.end_date and not cart.is_paid %}
                                    <p class="text-danger small">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏ä‡πà‡∏≤</p>
                                {% endif %}
                            </div>
                            <div class="item-total-price">
                                <p>‡∏ø{{ item.get_total_item_price|floatformat:2 }}</p>
                            </div>
                            <div class="item-actions">
                               {% if not cart.is_paid %}
                               <a href="{% url 'outfits:remove_from_cart' item.id %}" class="remove-link" title="‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ">√ó</a>
                               {% endif %}
                            </div>
                        </div>
                        {% endwith %}
                        {% endfor %}
                    </div>
                </main>

                <aside class="cart-summary-column">
                    <div class="summary-card">
                        <h4>‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h4>
                        <dl class="summary-list">
                            <dt>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</dt>
                            <dd>‡∏ø{{ cart.total_price|default:"0.00"|floatformat:2 }}</dd>
                            <dt class="summary-total">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥:</dt>
                            <dd class="summary-total-value">‡∏ø{{ cart.total_price|default:"0.00"|floatformat:2 }}</dd>
                        </dl>

                        {% if cart.cart_items_cart.exists and not cart.is_paid %}
                            {% if all_dates_selected_for_cart %}  {% comment %} <<< ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏à‡∏≤‡∏Å view ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà {% endcomment %}
                                <a href="{% url 'outfits:payment' %}" class="btn btn-primary btn-lg checkout-button">‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</a>
                            {% else %}
                                <p class="text-danger small">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏ä‡πà‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô</p>
                                <button class="btn btn-primary btn-lg checkout-button" disabled>‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</button>
                            {% endif %}
                        {% elif cart.is_paid %}
                             <p class="text-success small">‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß</p>
                        {% else %}
                             <button class="btn btn-primary btn-lg checkout-button" disabled>‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</button>
                        {% endif %}
                        <a href="{% url 'outfits:outfit-list' %}" class="continue-shopping-link">‚Üê ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡πà‡∏≠</a>
                    </div>
                </aside>
            </div>
        {% endif %}
    </div>
</section>
{% endblock %}